@using Linqraft.Playground.Services
@inject ShikiHighlightService ShikiHighlighter

<div class="flex min-h-[50px] flex-col overflow-hidden @(IsCollapsed ? "h-10" : "h-full")">
    <div class="flex cursor-pointer select-none items-center gap-2 border-b border-gray-700 bg-gray-800 px-3 py-2 text-gray-300 hover:bg-gray-700" @onclick="ToggleCollapse">
        <span class="text-sm">@Icon</span>
        <span class="flex-1 text-xs font-medium">@Title</span>
        <span class="text-xs text-gray-500 opacity-50">
            @(IsCollapsed ? "‚ñº" : "‚ñ≤")
        </span>
    </div>
    <div class="relative flex-1 overflow-auto" style="@(IsCollapsed ? "display: none;" : "")" translate="no">
        <div class="code-block-shiki h-full">
            @((MarkupString)highlightedCode)
        </div>
    </div>
</div>

@code {
    [Parameter] public string EditorId { get; set; } = "preview";
    [Parameter] public string Title { get; set; } = "Preview";
    [Parameter] public string Icon { get; set; } = "üîç";
    [Parameter] public string InitialContent { get; set; } = "";
    [Parameter] public bool IsCollapsed { get; set; } = false;
    [Parameter] public EventCallback<bool> IsCollapsedChanged { get; set; }
    [Parameter] public bool IsExpressionPane { get; set; } = false;

    private string currentContent = "";
    private string highlightedCode = "";

    protected override async Task OnInitializedAsync()
    {
        currentContent = InitialContent;
        if (!string.IsNullOrWhiteSpace(currentContent))
        {
            highlightedCode = await ShikiHighlighter.HighlightAsync(currentContent);
        }
    }

    private async Task ToggleCollapse()
    {
        IsCollapsed = !IsCollapsed;
        await IsCollapsedChanged.InvokeAsync(IsCollapsed);
    }

    public async Task SetValueAsync(string content)
    {
        currentContent = content;
        if (!string.IsNullOrWhiteSpace(content))
        {
            highlightedCode = await ShikiHighlighter.HighlightAsync(content);
        }
        else
        {
            highlightedCode = "";
        }
        StateHasChanged();
    }

    public Task<string> GetValueAsync()
    {
        return Task.FromResult(currentContent);
    }
}
