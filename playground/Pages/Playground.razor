@page "/playground"
@using Linqraft.Core
@using Linqraft.Playground.Services
@using Microsoft.AspNetCore.Components.WebAssembly.Services
@inject LazyAssemblyLoader AssemblyLoader
@inject IJSRuntime JSRuntime

<PageTitle>Linqraft Playground</PageTitle>

@if (!isInitialized)
{
    <LoadingAssemblies />
}
else
{
    <div class="flex h-full w-full overflow-hidden">
        <!-- Collapsible Sidebar -->
        <Sidebar 
            Collapsed="sidebarCollapsed"
            TemplatesExpanded="templatesExpanded"
            FilesExpanded="filesExpanded"
            Templates="templates"
            SelectedTemplate="selectedTemplate"
            SelectedFile="selectedFile"
            Configuration="configuration"
            OnToggle="ToggleSidebar"
            OnToggleTemplates="ToggleTemplatesSection"
            OnToggleFiles="ToggleFilesSection"
            OnSelectTemplate="SelectTemplate"
            OnSelectFile="SelectFile"
            OnConfigurationChanged="OnConfigurationChanged" />

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Editor Pane (Left) -->
            <div class="flex-1 flex flex-col min-w-[200px] overflow-hidden">
                <EditorPane 
                    @ref="editorPane"
                    EditorId="editor"
                    FileName="@selectedFile?.Name"
                    InitialContent="@(selectedFile?.Content ?? "// Select a file to edit")"
                    OnContentChanged="OnEditorContentChanged" />
            </div>

            <div class="w-1 bg-gray-700 flex items-center justify-center"></div>

            <!-- Preview Panes (Right) -->
            <div class="flex-1 flex flex-col min-w-[200px] overflow-hidden">
                <!-- Query Expression Preview -->
                <div class="@(queryPaneCollapsed ? "" : "flex-1") min-h-[50px] overflow-hidden">
                    <PreviewPane 
                        @ref="queryPreviewPane"
                        EditorId="queryPreview"
                        Title="Generated Expression"
                        Icon="ðŸ”"
                        InitialContent="// Generated expression will appear here"
                        IsCollapsed="queryPaneCollapsed"
                        IsExpressionPane="true"
                        IsCollapsedChanged="@(collapsed => { queryPaneCollapsed = collapsed; StateHasChanged(); })" />
                </div>

                @if (!queryPaneCollapsed && !dtoPaneCollapsed)
                {
                    <div class="h-1 bg-gray-700 flex items-center justify-center"></div>
                }

                <!-- DTO Class Preview -->
                <div class="@(dtoPaneCollapsed ? "" : "flex-1") min-h-[50px] overflow-hidden">
                    <PreviewPane 
                        @ref="dtoPreviewPane"
                        EditorId="dtoPreview"
                        Title="Generated DTO Class"
                        Icon="ðŸ“¦"
                        InitialContent="// Generated DTO class will appear here"
                        IsCollapsed="dtoPaneCollapsed"
                        IsExpressionPane="false"
                        IsCollapsedChanged="@(collapsed => { dtoPaneCollapsed = collapsed; StateHasChanged(); })" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    private const int DebounceDelayMs = 300;
    
    private bool isInitialized = false;
    private EditorPane? editorPane;
    private PreviewPane? queryPreviewPane;
    private PreviewPane? dtoPreviewPane;

    private List<Models.Template> templates = new();
    private Models.Template? selectedTemplate;
    private Models.ProjectFile? selectedFile;

    private bool sidebarCollapsed = false;
    private bool templatesExpanded = true;
    private bool filesExpanded = true;
    private bool queryPaneCollapsed = false;
    private bool dtoPaneCollapsed = false;
    
    // Services loaded lazily
    private TemplateService? templateService;
    private CodeGenerationService? codeGenerationService;
    
    // Configuration with CommentOutput set to None by default
    private LinqraftConfiguration configuration = new() { CommentOutput = CommentOutputMode.None };

    protected override async Task OnInitializedAsync()
    {
        // Load required assemblies lazily
        var assemblies = await AssemblyLoader.LoadAssembliesAsync(new[]
        {
            "Microsoft.CodeAnalysis.dll",
            "Microsoft.CodeAnalysis.CSharp.dll",
            "Basic.Reference.Assemblies.Net90.dll",
            "BlazorMonaco.dll"
        });
        
        // Initialize services after assemblies are loaded
        var sharedCompilationService = new SharedCompilationService();
        templateService = new TemplateService();
        codeGenerationService = new CodeGenerationService(sharedCompilationService);
        
        // Get templates
        templates = templateService.GetTemplates();
        if (templates.Count > 0)
        {
            selectedTemplate = templates[0];
            var visibleFiles = selectedTemplate.VisibleFiles.ToList();
            if (visibleFiles.Count > 0)
            {
                selectedFile = visibleFiles.FirstOrDefault(f => 
                    f.Content.Contains("SelectExpr")) 
                    ?? visibleFiles[0];
            }
        }
        
        isInitialized = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && isInitialized && selectedTemplate != null)
        {
            await Task.Delay(100);
            await GeneratePreviewForTemplate();
        }
    }

    private void ToggleSidebar() => sidebarCollapsed = !sidebarCollapsed;
    private void ToggleTemplatesSection() => templatesExpanded = !templatesExpanded;
    private void ToggleFilesSection() => filesExpanded = !filesExpanded;
    
    private async Task OnConfigurationChanged(LinqraftConfiguration config)
    {
        configuration = config;
        await GeneratePreviewForTemplate();
    }

    private async Task SelectTemplate(Models.Template template)
    {
        selectedTemplate = template;
        var visibleFiles = template.VisibleFiles.ToList();
        if (visibleFiles.Count > 0)
        {
            selectedFile = visibleFiles.FirstOrDefault(f => f.Content.Contains("SelectExpr")) 
                ?? visibleFiles[0];
            if (editorPane != null)
            {
                await editorPane.SetValueAsync(selectedFile.Content);
            }
        }
        await GeneratePreviewForTemplate();
    }

    private async Task SelectFile(Models.ProjectFile file)
    {
        selectedFile = file;
        if (editorPane != null)
        {
            await editorPane.SetValueAsync(file.Content);
        }
    }

    private System.Timers.Timer? debounceTimer;

    private async Task OnEditorContentChanged(ModelContentChangedEvent e)
    {
        if (selectedFile != null && editorPane != null)
        {
            selectedFile.Content = await editorPane.GetValueAsync();
        }

        debounceTimer?.Stop();
        debounceTimer?.Dispose();
        debounceTimer = new System.Timers.Timer(DebounceDelayMs);
        debounceTimer.Elapsed += async (sender, args) =>
        {
            debounceTimer?.Stop();
            await InvokeAsync(async () => await GeneratePreviewForTemplate());
        };
        debounceTimer.AutoReset = false;
        debounceTimer.Start();
    }

    private async Task GeneratePreviewForTemplate()
    {
        if (selectedTemplate == null || codeGenerationService == null) return;

        try
        {
            _ = InvokeAsync(async () => 
            {
                var output = codeGenerationService.GenerateOutput(selectedTemplate.Files, configuration);

                if (queryPreviewPane != null)
                {
                    await queryPreviewPane.SetValueAsync(output.HasError ? $"// Error: {output.ErrorMessage}" : output.QueryExpression);
                }

                if (dtoPreviewPane != null)
                {
                    await dtoPreviewPane.SetValueAsync(output.HasError ? $"// Error: {output.ErrorMessage}" : output.DtoClass);
                }
            });
        }
        catch (Exception)
        {
            // Editor not yet initialized, ignore
        }
    }
}
