@using BlazorMonaco
@using BlazorMonaco.Editor

<div class="flex flex-col min-h-[50px] overflow-hidden @(IsCollapsed ? "h-10" : "h-full")">
    <div class="flex items-center gap-2 px-3 py-2 bg-gray-800 border-b border-gray-700 text-gray-300">
        <span class="text-sm">@Icon</span>
        <span class="flex-1 text-xs font-medium">@Title</span>
        <button class="text-xs text-gray-400 hover:text-white px-2 py-1 rounded hover:bg-gray-700"
                @onclick="ToggleCollapse"
                title="@(IsCollapsed ? "Expand" : "Collapse")">
            @(IsCollapsed ? "‚ñº" : "‚ñ≤")
        </button>
    </div>
    @if (!IsCollapsed)
    {
        <div class="flex-1 overflow-hidden relative">
            <StandaloneCodeEditor @ref="Editor"
                Id="@EditorId"
                ConstructionOptions="GetConstructionOptions" />
        </div>
    }
</div>

@code {
    [Parameter] public string EditorId { get; set; } = "preview";
    [Parameter] public string Title { get; set; } = "Preview";
    [Parameter] public string Icon { get; set; } = "üîç";
    [Parameter] public string InitialContent { get; set; } = "";
    [Parameter] public bool IsCollapsed { get; set; } = false;
    [Parameter] public EventCallback<bool> IsCollapsedChanged { get; set; }

    public StandaloneCodeEditor? Editor { get; private set; }

    private StandaloneEditorConstructionOptions GetConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "csharp",
            Theme = "vs", // Visual Studio light theme (closest to VS)
            Value = InitialContent,
            FontSize = 13,
            FontFamily = "'JetBrains Mono', monospace",
            ReadOnly = true,
            Minimap = new EditorMinimapOptions { Enabled = false },
            ScrollBeyondLastLine = false,
            RenderLineHighlight = "none",
            TabSize = 4,
        };
    }

    private async Task ToggleCollapse()
    {
        IsCollapsed = !IsCollapsed;
        await IsCollapsedChanged.InvokeAsync(IsCollapsed);
    }

    public async Task SetValueAsync(string content)
    {
        if (Editor != null)
        {
            try
            {
                await Editor.SetValue(content);
            }
            catch
            {
                // Editor not yet initialized
            }
        }
    }
}
