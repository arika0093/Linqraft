using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Environments;
using BenchmarkDotNet.Jobs;
using BenchmarkDotNet.Running;

namespace Linqraft.Benchmark;

class Program
{
    static async Task Main(string[] args)
    {
#if DEBUG
        // Debug mode: Run simple verification
        Console.WriteLine("=== Running in DEBUG mode - Verification Run ===");
        Console.WriteLine("This will execute each benchmark method once to verify functionality.");
        Console.WriteLine();

        var benchmark = new SelectBenchmark { DataCount = 100 };

        try
        {
            Console.WriteLine("Setting up benchmark...");
            await benchmark.Setup();
            Console.WriteLine("Setup completed successfully.");
            Console.WriteLine();

            var methods = new (string Name, Func<Task<int>> Method)[]
            {
                ("Traditional Anonymous", benchmark.Traditional_Anonymous),
                ("Traditional Manual DTO", benchmark.Traditional_ManualDto),
                ("Linqraft Anonymous", benchmark.Linqraft_Anonymous),
                ("Linqraft Auto-Generated DTO", benchmark.Linqraft_AutoGeneratedDto),
                ("Linqraft Manual DTO", benchmark.Linqraftl_ManualDto),
                ("AutoMapper ProjectTo", benchmark.AutoMapper_ProjectTo),
                ("Mapperly Projection", benchmark.Mapperly_Projection),
                ("Mapster ProjectToType", benchmark.Mapster_ProjectToType),
                ("Facet ToFacetsAsync", benchmark.Facet_ToFacetsAsync),
            };

            foreach (var (name, method) in methods)
            {
                Console.Write($"Testing {name}... ");
                try
                {
                    var result = await method();
                    Console.WriteLine($"✓ OK (Count: {result})");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"✗ FAILED");
                    Console.WriteLine($"  Error: {ex.Message}");
                    if (ex.InnerException != null)
                    {
                        Console.WriteLine($"  Inner: {ex.InnerException.Message}");
                    }
                }
            }

            Console.WriteLine();
            Console.WriteLine("Cleaning up...");
            await benchmark.Cleanup();
            Console.WriteLine("Cleanup completed.");
            Console.WriteLine();
            Console.WriteLine("=== Verification Run Completed ===");
            Console.WriteLine("Build in Release mode to run actual benchmarks.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fatal error: {ex.Message}");
            Console.WriteLine(ex.StackTrace);
            return;
        }
#else
        BenchmarkRunner.Run<SelectBenchmark>();
#endif
    }
}
