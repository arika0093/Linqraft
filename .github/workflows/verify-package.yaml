# This workflow verifies that the packed NuGet package can be installed and used correctly.
# It creates a test project, installs the locally packed Linqraft package,
# and runs a sample program to ensure the Source Generator works as expected.

name: Verify NuGet Package

on:
  workflow_dispatch:
  push:
    paths:
      - 'src/**/*.cs'
      - 'src/**/*.csproj'
      - '.github/workflows/verify-package.yaml'

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  verify-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          cache: true
          cache-dependency-path: '**/packages.lock.json'

      - name: Restore dependencies
        run: dotnet restore --locked-mode

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Pack NuGet packages
        run: dotnet pack --no-build -c Release --output ./local-packages

      - uses: dotnet/nbgv@master
        id: nbgv

      - name: Setup local NuGet source
        shell: bash
        run: |
          dotnet nuget add source "$(pwd)/local-packages" --name LocalPackages || true

      - name: Create test project directory
        shell: bash
        run: mkdir -p ./verification-test

      - name: Create verification test project directory
        shell: bash
        working-directory: ./verification-test
        run: |
          mkdir -p PackageVerification

      - name: Create project file with package reference
        shell: bash
        working-directory: ./verification-test/PackageVerification
        run: |
          cat > PackageVerification.csproj << 'EOF'
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <OutputType>Exe</OutputType>
              <TargetFramework>net10.0</TargetFramework>
              <ImplicitUsings>enable</ImplicitUsings>
              <Nullable>enable</Nullable>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="Linqraft" Version="${{ steps.nbgv.outputs.SemVer2 }}" />
            </ItemGroup>
          </Project>
          EOF

      - name: Copy Program.cs from MinimumSample
        shell: bash
        run: |
          cp examples/Linqraft.MinimumSample/Program.cs verification-test/PackageVerification/Program.cs

      - name: Build verification project
        working-directory: ./verification-test/PackageVerification
        run: dotnet build

      - name: Run and verify output
        shell: bash
        working-directory: ./verification-test/PackageVerification
        run: |
          OUTPUT=$(dotnet run --no-build)
          echo "=== Program Output ==="
          echo "$OUTPUT"
          echo "======================"

          # Verify that the output contains expected data
          if echo "$OUTPUT" | grep -q "John Doe"; then
            echo "✓ Verification passed: Output contains expected data"
          else
            echo "✗ Verification failed: Output does not contain expected data"
            exit 1
          fi
