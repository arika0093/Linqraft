
# <img width="24" src="./assets/linqraft.png" /> Linqraft 

[![NuGet Version](https://img.shields.io/nuget/v/Linqraft?style=flat-square&logo=NuGet&color=0080CC)](https://www.nuget.org/packages/Linqraft/) ![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/arika0093/Linqraft/test.yaml?branch=main&label=Test&style=flat-square) [![DeepWiki](https://img.shields.io/badge/DeepWiki-Linqraft-blue.svg?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAyCAYAAAAnWDnqAAAAAXNSR0IArs4c6QAAA05JREFUaEPtmUtyEzEQhtWTQyQLHNak2AB7ZnyXZMEjXMGeK/AIi+QuHrMnbChYY7MIh8g01fJoopFb0uhhEqqcbWTp06/uv1saEDv4O3n3dV60RfP947Mm9/SQc0ICFQgzfc4CYZoTPAswgSJCCUJUnAAoRHOAUOcATwbmVLWdGoH//PB8mnKqScAhsD0kYP3j/Yt5LPQe2KvcXmGvRHcDnpxfL2zOYJ1mFwrryWTz0advv1Ut4CJgf5uhDuDj5eUcAUoahrdY/56ebRWeraTjMt/00Sh3UDtjgHtQNHwcRGOC98BJEAEymycmYcWwOprTgcB6VZ5JK5TAJ+fXGLBm3FDAmn6oPPjR4rKCAoJCal2eAiQp2x0vxTPB3ALO2CRkwmDy5WohzBDwSEFKRwPbknEggCPB/imwrycgxX2NzoMCHhPkDwqYMr9tRcP5qNrMZHkVnOjRMWwLCcr8ohBVb1OMjxLwGCvjTikrsBOiA6fNyCrm8V1rP93iVPpwaE+gO0SsWmPiXB+jikdf6SizrT5qKasx5j8ABbHpFTx+vFXp9EnYQmLx02h1QTTrl6eDqxLnGjporxl3NL3agEvXdT0WmEost648sQOYAeJS9Q7bfUVoMGnjo4AZdUMQku50McDcMWcBPvr0SzbTAFDfvJqwLzgxwATnCgnp4wDl6Aa+Ax283gghmj+vj7feE2KBBRMW3FzOpLOADl0Isb5587h/U4gGvkt5v60Z1VLG8BhYjbzRwyQZemwAd6cCR5/XFWLYZRIMpX39AR0tjaGGiGzLVyhse5C9RKC6ai42ppWPKiBagOvaYk8lO7DajerabOZP46Lby5wKjw1HCRx7p9sVMOWGzb/vA1hwiWc6jm3MvQDTogQkiqIhJV0nBQBTU+3okKCFDy9WwferkHjtxib7t3xIUQtHxnIwtx4mpg26/HfwVNVDb4oI9RHmx5WGelRVlrtiw43zboCLaxv46AZeB3IlTkwouebTr1y2NjSpHz68WNFjHvupy3q8TFn3Hos2IAk4Ju5dCo8B3wP7VPr/FGaKiG+T+v+TQqIrOqMTL1VdWV1DdmcbO8KXBz6esmYWYKPwDL5b5FA1a0hwapHiom0r/cKaoqr+27/XcrS5UwSMbQAAAABJRU5ErkJggg==)](https://deepwiki.com/arika0093/Linqraft)

Write Select queries easily with on-demand DTO generation and null-propagation operators. No dependencies.

[Web Page](https://arika0093.github.io/Linqraft/) | [Online Playground](https://arika0093.github.io/Linqraft/playground/)

## Table of Contents

* [Features](#features)
* [Quick Start](#quick-start)
  * [Installation](./docs/library/installation.md)
  * [Basic Usage](#basic-usage)
* [Documentation](#documentation)
  * [Usage Patterns](./docs/library/usage-patterns.md) - Anonymous, Explicit DTO, and Pre-existing DTO patterns
  * [Customization](./docs/library/customization.md) - Local variables, partial classes, global properties, and more
  * [Performance](./docs/library/performance.md) - Benchmarks and library comparisons
  * [FAQ](./docs/library/faq.md) - Common questions and troubleshooting
  * [Analyzers](./docs/analyzers/README.md) - Code analyzers and fixes
* [Examples](#examples)
* [License](#license)

## Features
### Overview
Linqraft is a Roslyn Source Generator for easily writing `IQueryable` projections.

* **Query-based** automatic DTO generation
  * You can freely define DTO structures in the query without predefining them.
  * Based on anonymous types, "what you see is what you get" declarations.
  * Supports nested DTOs, collections, and calculated fields.
* Null-propagation operator support (`?.`) in Expression Trees
  * No more need to write `o.Customer != null ? o.Customer.Name : null`.
* Zero-dependency
  * No runtime dependencies are required since it uses Source Generators and Interceptors.

With Linqraft, you can write queries like this:

```csharp
var orders = await dbContext.Orders
    // Order: input entity type
    // OrderDto: output DTO type (auto-generated)
    .SelectExpr<Order, OrderDto>(o => new
    {
        // can use inferred member names
        o.Id,
        // null-propagation supported
        // you can create flattened structures easily
        CustomerName = o.Customer?.Name,
        // also works for nested objects
        CustomerCountry = o.Customer?.Address?.Country?.Name,
        CustomerCity = o.Customer?.Address?.City?.Name,
        // you can use anonymous types inside. great for grouping
        CustomerInfo = new
        {
            Email = o.Customer?.EmailAddress,
            Phone = o.Customer?.PhoneNumber,
        },
        // calculated fields? no problem!
        LatestOrderDate = o.OrderItems.Max(oi => oi.OrderDate),
        TotalAmount = o.OrderItems.Sum(oi => oi.Quantity * oi.UnitPrice),
        // collections available
        Items = o.OrderItems.Select(oi => new
        {
            // of course, features work here too
            ProductName = oi.Product?.Name,
            oi.Quantity
        }),
    })
    .ToListAsync();
```

By specifying `OrderDto` as the generic parameter for `SelectExpr`, DTO types are generated **automatically** from the anonymous-type selector.
That means **you don't need to manually declare** `OrderDto` or `OrderItemDto`. 

for example, the generated code looks like this:

<details>
<summary>Generated code example</summary>

```csharp
// <auto-generated>
// This file is auto-generated by Linqraft 
// </auto-generated>
#nullable enable
#pragma warning disable IDE0060
#pragma warning disable CS8601
#pragma warning disable CS8602
#pragma warning disable CS8603
#pragma warning disable CS8604
#pragma warning disable CS8618
using System;
using System.Linq;
using System.Collections.Generic;
namespace Linqraft
{
    file static partial class GeneratedExpression
    {
        [global::System.Runtime.CompilerServices.InterceptsLocationAttribute(1, "HWIj1D9ydZTCzRj7o0y/oYkBAABUdXRvcmlhbENhc2VUZXN0LmNz")]
        public static IQueryable<TResult> SelectExpr_CE7A5A7D_5A34E201<TIn, TResult>(
            this IQueryable<TIn> query, Func<TIn, object> selector)
        {
            var matchedQuery = query as object as IQueryable<global::Tutorial.Order>;
            var converted = matchedQuery.Select(o => new global::Tutorial.OrderDto
            {
                Id = o.Id,
                CustomerName = o.Customer != null ? (string?)o.Customer.Name : null,
                CustomerCountry = o.Customer != null && o.Customer.Address != null && o.Customer.Address.Country != null ? (string?)o.Customer.Address.Country.Name : null,
                CustomerCity = o.Customer != null && o.Customer.Address != null && o.Customer.Address.City != null ? (string?)o.Customer.Address.City.Name : null,
                CustomerInfo = new global::Tutorial.LinqraftGenerated_F1A64BF4.CustomerInfoDto
                {
                    Email = o.Customer != null ? (string?)o.Customer.EmailAddress : null,
                    Phone = o.Customer != null ? (string?)o.Customer.PhoneNumber : null
                },
                LatestOrderDate = o.OrderItems.Max(oi => oi.OrderDate),
                TotalAmount = o.OrderItems.Sum(oi => oi.Quantity * oi.UnitPrice),
                Items = o.OrderItems
                    .Select(oi => new global::Tutorial.LinqraftGenerated_DE33EA40.ItemsDto
                    {
                        ProductName = oi.Product != null ? (string?)oi.Product.Name : null,
                        Quantity = oi.Quantity
                    })
            });
            return converted as object as IQueryable<TResult>;
        }

    }
}
namespace Tutorial
{
    public partial class OrderDto
    {
        public required int Id { get; set; }
        public required string? CustomerName { get; set; }
        public required string? CustomerCountry { get; set; }
        public required string? CustomerCity { get; set; }
        public required global::Tutorial.LinqraftGenerated_F1A64BF4.CustomerInfoDto? CustomerInfo { get; set; }
        public required global::System.DateTime LatestOrderDate { get; set; }
        public required decimal TotalAmount { get; set; }
        public required global::System.Collections.Generic.IEnumerable<Tutorial.LinqraftGenerated_DE33EA40.ItemsDto> Items { get; set; }
    }
}
namespace Tutorial.LinqraftGenerated_DE33EA40
{
    [global::System.ComponentModel.EditorBrowsable(global::System.ComponentModel.EditorBrowsableState.Never)]
    [Linqraft.LinqraftAutoGeneratedDtoAttribute]
    public partial class ItemsDto
    {
        public required string? ProductName { get; set; }
        public required int Quantity { get; set; }
    }
}
namespace Tutorial.LinqraftGenerated_F1A64BF4
{
    [global::System.ComponentModel.EditorBrowsable(global::System.ComponentModel.EditorBrowsableState.Never)]
    [Linqraft.LinqraftAutoGeneratedDtoAttribute]
    public partial class CustomerInfoDto
    {
        public required string? Email { get; set; }
        public required string? Phone { get; set; }
    }
}
```

</details>

Interested? Try it out in the [Playground](https://arika0093.github.io/Linqraft/playground/)!

### Drop-in Replacement Analyzers

[Analyzers](./docs/analyzers/README.md) are provided to replace existing Select code with Linqraft. The replacement is completed in an instant.

![](./assets/replace-codefix-sample.gif)

## Quick Start

### Installation

For detailed installation instructions, see the [Installation Guide](./docs/library/installation.md).

#### Prerequisites
This library requirements **C# 12.0 or later** because it uses the [interceptor](https://learn.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-12#interceptors) feature.  


<details>
<summary>.NET 7 or below setup</summary>

Set the `LangVersion` property to `12.0` or later and use [Polysharp](https://github.com/Sergio0694/PolySharp/) to enable C# latest features.

```xml
<Project>
  <PropertyGroup>
    <LangVersion>12.0</LangVersion>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Polysharp" Version="1.*" />
  </ItemGroup>
</Project>
```

</details>

Also, due to the constraints of `Microsoft.CodeAnalysis.CSharp`, One of the following environment is [required](https://andrewlock.net/supporting-multiple-sdk-versions-in-analyzers-and-source-generators/):

* .NET 8.0.400 or later **SDK**
* Visual Studio 2022 version 17.11 or later

> [!NOTE]
> This is only a constraint on the SDK side, so the runtime(target framework) can be older versions.

#### Installation

Install `Linqraft` from NuGet:

```bash
dotnet add package Linqraft
```

For more details, see the [Installation Guide](./docs/library/installation.md).

### Basic Usage

Linqraft provides three main usage patterns. For detailed information, see the [Usage Patterns Guide](./docs/library/usage-patterns.md).

#### Anonymous pattern

Use `SelectExpr` without generics to get an anonymous-type projection:

```csharp
var orders = await dbContext.Orders
    .SelectExpr(o => new
    {
        Id = o.Id,
        CustomerName = o.Customer?.Name,
        // ...
    })
    .ToListAsync();
```

#### Explicit DTO pattern

Specify the generics to generate a DTO class:

```csharp
var orders = await dbContext.Orders
    // Order: input entity type
    // OrderDto: output DTO type (auto-generated)
    .SelectExpr<Order, OrderDto>(o => new
    {
        Id = o.Id,
        CustomerName = o.Customer?.Name,
        // ...
    })
    .ToListAsync();
```

#### Pre-existing DTO pattern

Use your existing DTO classes:

```csharp
var orders = await dbContext.Orders
    .SelectExpr(o => new OrderDto
    {
        Id = o.Id,
        CustomerName = o.Customer?.Name,
        // ...
    })
    .ToListAsync();

// your existing DTO class
public class OrderDto { /* ... */ }
```

For more usage patterns and examples, see the [Usage Patterns Guide](./docs/library/usage-patterns.md).

## Documentation

### Usage & Configuration

* **[Installation Guide](./docs/library/installation.md)** - Prerequisites, installation, and setup
* **[Usage Patterns](./docs/library/usage-patterns.md)** - Anonymous, Explicit DTO, and Pre-existing DTO patterns
* **[Customization](./docs/library/customization.md)** - Local variables, partial classes, global properties, and more
* **[Performance](./docs/library/performance.md)** - Benchmarks and comparisons with other libraries
* **[FAQ](./docs/library/faq.md)** - Common questions and troubleshooting

### Advanced Topics

For advanced customization options, see the [Customization Guide](./docs/library/customization.md):

* [Local Variable Capture](./docs/library/customization.md#local-variable-capture) - Using local variables in SelectExpr
* [Array Nullability Removal](./docs/library/customization.md#array-nullability-removal) - Automatic null handling for collections
* [Partial Classes](./docs/library/customization.md#partial-classes) - Extending generated DTOs
* [Property Accessibility Control](./docs/library/customization.md#property-accessibility-control) - Internal properties
* [Nested DTO Naming](./docs/library/customization.md#nested-dto-naming) - Customizing nested DTO names
* [Auto-Generated Comments](./docs/library/customization.md#auto-generated-comments) - XML documentation generation
* [Global Properties](./docs/library/customization.md#global-properties) - MSBuild configuration options

## Examples

Example projects are available in the [examples](./examples) folder:

* [Linqraft.Sample](./examples/Linqraft.Sample) - Basic usage examples
* [Linqraft.MinimumSample](./examples/Linqraft.MinimumSample) - Minimal working example
* [Linqraft.ApiSample](./examples/Linqraft.ApiSample) - API integration example
* [Linqraft.Benchmark](./examples/Linqraft.Benchmark) - Performance benchmarks

## License
This project is licensed under the Apache License 2.0.
