using System.Threading.Tasks;
using Microsoft.CodeAnalysis;
using VerifyCS = Microsoft.CodeAnalysis.CSharp.Testing.CSharpAnalyzerVerifier<
    Linqraft.Analyzer.AutoGeneratedDtoUsageAnalyzer,
    Microsoft.CodeAnalysis.Testing.DefaultVerifier
>;

namespace Linqraft.Analyzer.Tests;

public class AutoGeneratedDtoUsageAnalyzerTests
{
    private const string LinqraftAutoGeneratedDtoAttributeDefinition =
        @"
namespace Linqraft
{
    [System.AttributeUsage(System.AttributeTargets.Class | System.AttributeTargets.Struct)]
    internal sealed class LinqraftAutoGeneratedDtoAttribute : System.Attribute { }
}
";

    [Fact]
    public async Task ObjectCreation_WithAutoGeneratedDto_ReportsDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    void Method()
    {
        var dto = new {|#0:GeneratedDto|}();
    }
}";

        var expected = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(0)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        await VerifyCS.VerifyAnalyzerAsync(test, expected);
    }

    [Fact]
    public async Task ObjectCreation_WithNormalClass_NoDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
class NormalDto
{
    public int Id { get; set; }
}

class Test
{
    void Method()
    {
        var dto = new NormalDto();
    }
}";

        await VerifyCS.VerifyAnalyzerAsync(test);
    }

    [Fact]
    public async Task MethodParameter_WithAutoGeneratedDto_ReportsDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    void Method({|#0:GeneratedDto|} dto)
    {
    }
}";

        var expected = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(0)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        await VerifyCS.VerifyAnalyzerAsync(test, expected);
    }

    [Fact]
    public async Task MethodParameter_WithNormalClass_NoDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
class NormalDto
{
    public int Id { get; set; }
}

class Test
{
    void Method(NormalDto dto)
    {
    }
}";

        await VerifyCS.VerifyAnalyzerAsync(test);
    }

    [Fact]
    public async Task ExplicitVariableDeclaration_WithAutoGeneratedDto_ReportsDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    GeneratedDto GetDto() => null;

    void Method()
    {
        {|#0:GeneratedDto|} dto = GetDto();
    }
}";

        var expected = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(0)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        await VerifyCS.VerifyAnalyzerAsync(test, expected);
    }

    [Fact]
    public async Task VarVariableDeclaration_WithAutoGeneratedDto_NoDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    GeneratedDto GetDto() => null;

    void Method()
    {
        var dto = GetDto();
    }
}";

        await VerifyCS.VerifyAnalyzerAsync(test);
    }

    [Fact]
    public async Task PropertyDeclaration_WithAutoGeneratedDto_ReportsDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    public {|#0:GeneratedDto|} MyDto { get; set; }
}";

        var expected = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(0)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        await VerifyCS.VerifyAnalyzerAsync(test, expected);
    }

    [Fact]
    public async Task FieldDeclaration_WithAutoGeneratedDto_ReportsDiagnostic()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    private {|#0:GeneratedDto|} _myDto;
}";

        var expected = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(0)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        await VerifyCS.VerifyAnalyzerAsync(test, expected);
    }

    [Fact]
    public async Task MultipleUsages_WithAutoGeneratedDto_ReportsMultipleDiagnostics()
    {
        var test =
            LinqraftAutoGeneratedDtoAttributeDefinition
            + @"
[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    public {|#0:GeneratedDto|} MyDto { get; set; }
    private {|#1:GeneratedDto|} _myDto;

    void Method({|#2:GeneratedDto|} dto)
    {
        {|#3:GeneratedDto|} localDto = null;
        var another = new {|#4:GeneratedDto|}();
    }
}";

        var expected0 = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(0)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        var expected1 = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(1)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        var expected2 = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(2)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        var expected3 = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(3)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        var expected4 = VerifyCS
            .Diagnostic(AutoGeneratedDtoUsageAnalyzer.AnalyzerId)
            .WithLocation(4)
            .WithSeverity(DiagnosticSeverity.Warning)
            .WithArguments("GeneratedDto");

        await VerifyCS.VerifyAnalyzerAsync(
            test,
            expected0,
            expected1,
            expected2,
            expected3,
            expected4
        );
    }

    [Fact]
    public async Task LambdaParameter_InferredType_NoDiagnostic()
    {
        var test =
            @"
using System.Linq;
using System.Collections.Generic;

namespace Linqraft
{
    [System.AttributeUsage(System.AttributeTargets.Class | System.AttributeTargets.Struct)]
    internal sealed class LinqraftAutoGeneratedDtoAttribute : System.Attribute { }
}

[Linqraft.LinqraftAutoGeneratedDtoAttribute]
class GeneratedDto
{
    public int Id { get; set; }
}

class Test
{
    void Method()
    {
        var list = new List<GeneratedDto>();
        var result = list.Where(x => x.Id > 0);
    }
}";

        // Lambda parameter 'x' has inferred type, no diagnostic
        await VerifyCS.VerifyAnalyzerAsync(test);
    }
}
